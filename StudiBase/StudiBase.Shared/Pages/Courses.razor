@page "/courses"
@using StudiBase.Shared.Clients
@using StudiBase.Shared.Contracts.DTOs
@using StudiBase.Shared.Contracts.Paging
@using StudiBase.Shared.Services
@implements IDisposable
@inject CourseApiClient CoursesApi
@inject TrainerApiClient TrainersApi
@inject FileApiClient FilesApi
@inject INetworkService Network

<h2 class="fw-bold mb-3 text-center">Courses</h2>

@* --- BANNER STATUS KONEKSI --- *@
@if (!Network.IsOnline)
{
    <div class="alert alert-danger d-flex align-items-center mb-4 shadow-sm">
        <i class="bi bi-wifi-off fs-4 me-3"></i>
        <div>
            <strong>Mode Offline!</strong> Fitur manajemen kursus dan upload dinonaktifkan sementara.
        </div>
    </div>
}

<div class="container-fluid px-0 mb-4">
    <div class="d-flex flex-wrap gap-2 justify-content-center">
        <input class="form-control" style="max-width:280px" placeholder="Search courses..." @bind="q" />
        <button class="btn btn-primary" @onclick="Search">Search</button>
        <button class="btn btn-outline-secondary" @onclick="Retry">Reload</button>
    </div>
</div>

@if (loading)
{
    <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
}
else
{
    @* --- FORM CREATE / EDIT (FULL COLUMNS) --- *@
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            @if (!isEdit)
            {
                <h5 class="card-title fw-bold text-success">Create Course</h5>
                <EditForm Model="newCourse" OnValidSubmit="HandleSubmit" class="row g-3">
                    <DataAnnotationsValidator />
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="newCourse.Title" placeholder="Course Title" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="newCourse.Category" placeholder="Category" /></div>
                    <div class="col-md-12"><InputTextArea class="form-control" @bind-Value="newCourse.Description" placeholder="Description" rows="2" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="newCourse.Level" placeholder="Level (Beginner/..)" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="newCourse.Status" placeholder="Status" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="newCourse.Visibility" placeholder="Visibility" /></div>
                    <div class="col-md-3"><InputText class="form-control" @bind-Value="newCourse.Language" placeholder="Language" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="newCourse.Duration" placeholder="Duration (min)" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="newCourse.TotalLessons" placeholder="Total Lessons" /></div>
                    <div class="col-md-3 d-flex align-items-center"><InputCheckbox @bind-Value="newCourse.IsFree" class="form-check-input me-2" /> Free Course</div>
                    <div class="col-md-4"><InputNumber class="form-control" @bind-Value="newCourse.Price" placeholder="Price" /></div>
                    <div class="col-md-8">
                        <select class="form-select" @bind="SelectedTrainerId">
                            <option value="0">-- Select Trainer --</option>
                            @foreach (var t in allTrainers)
                            {
                                <option value="@t.Id">@t.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-12"><button class="btn btn-success px-4" type="submit" disabled="@(!Network.IsOnline)">Create</button></div>
                </EditForm>
            }
            else
            {
                <h5 class="card-title fw-bold text-primary">Edit Course (ID: @editId)</h5>
                <EditForm Model="editCourse" OnValidSubmit="HandleSubmit" class="row g-3">
                    <DataAnnotationsValidator />
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="editCourse.Title" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="editCourse.Category" /></div>
                    <div class="col-md-12"><InputTextArea class="form-control" @bind-Value="editCourse.Description" rows="2" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="editCourse.Level" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="editCourse.Status" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="editCourse.Visibility" /></div>
                    <div class="col-md-3"><InputText class="form-control" @bind-Value="editCourse.Language" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="editCourse.Duration" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="editCourse.TotalLessons" /></div>
                    <div class="col-md-3 d-flex align-items-center"><InputCheckbox @bind-Value="editCourse.IsFree" class="form-check-input me-2" /> Free Course</div>
                    <div class="col-md-4"><InputNumber class="form-control" @bind-Value="editCourse.Price" /></div>
                    <div class="col-md-8">
                        <select class="form-select" @bind="SelectedTrainerId">
                            @foreach (var t in allTrainers)
                            {
                                <option value="@t.Id">@t.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-12 d-flex gap-2">
                        <button class="btn btn-primary px-4" type="submit" disabled="@(!Network.IsOnline)">Save</button>
                        <button class="btn btn-secondary px-4" type="button" @onclick="CancelEdit">Cancel</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>

    @* --- LIST COURSES (WITH THUMBNAIL) --- *@
    <div class="row g-4">
        @if (data?.Items != null)
        {
            @foreach (var c in data.Items)
            {
                var cardId = $"mats_{c.Id}";
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-0 overflow-hidden">
                        @* REVISI: Tampilkan Gambar Thumbnail *@
                        <div class="position-relative">
                            <img class="card-img-top" src="@GetThumb(c)" alt="thumb" style="height:180px; object-fit:cover;" />
                            <span class="badge bg-dark position-absolute top-0 start-0 m-2 opacity-75">@c.Category</span>
                            @if (c.IsFree)
                            {
                                <span class="badge bg-success position-absolute top-0 end-0 m-2">FREE</span>
                            }
                        </div>

                        <div class="card-body">
                            <h5 class="fw-bold text-truncate">@c.Title</h5>
                            <p class="small text-muted mb-2"><i class="bi bi-person"></i> @c.TrainerName</p>
                            <div class="d-flex gap-2 mb-3">
                                <span class="badge bg-light text-dark border">@c.Level</span>
                                <span class="badge bg-light text-dark border">@c.Duration min</span>
                            </div>

                            <div class="mb-3">
                                <label class="small fw-bold"><i class="bi bi-paperclip"></i> Materials:</label>
                                <InputFile class="form-control form-control-sm my-2" OnChange="@(e => UploadMaterialAsync(e, c.Id))" disabled="@(!Network.IsOnline)" />
                                <ul class="list-group list-group-flush border-top">
                                    @if (materials.TryGetValue(c.Id, out var mList))
                                    {
                                        foreach (var m in mList)
                                        {
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-1 small px-0">
                                                <span class="text-truncate" style="max-width: 80%;">@m.Title</span> @* Sesuai DTO: Title *@
                                                <button class="btn btn-link text-danger btn-sm p-0" @onclick="() => DeleteMaterialAsync(c.Id, m.Id)" disabled="@(!Network.IsOnline)"><i class="bi bi-trash"></i></button>
                                            </li>
                                        }
                                    }
                                </ul>
                            </div>

                            @* REVISI: Upload Thumbnail Baru *@
                            <div class="mb-3">
                                <label class="small fw-bold">Change Thumbnail:</label>
                                <InputFile class="form-control form-control-sm" OnChange="@(e => UploadThumbAsync(c.Id, e))" disabled="@(!Network.IsOnline)" />
                            </div>

                            <div class="pt-3 border-top d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" @onclick="() => BeginEdit(c)" disabled="@(!Network.IsOnline)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger flex-fill" @onclick="() => DeleteAsync(c.Id)" disabled="@(!Network.IsOnline)">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    string? q; int pageNumber = 1, pageSize = 10;
    bool loading, isEdit; int? editId; int SelectedTrainerId;
    PagedResult<CourseDto>? data;
    List<TrainerDto> allTrainers = new();
    CourseCreateDto newCourse = new();
    CourseUpdateDto editCourse = new();
    Dictionary<int, List<CourseMaterialDto>> materials = new();

    // --- LOGIC BACKEND URL (SAMA DENGAN TRAINERS) ---
    private string BackendUrl =>
#if WINDOWS
        "https://localhost:7231";
#else
        "https://loraine-seminiferous-snappily.ngrok-free.dev";
#endif

    // Helper untuk menampilkan thumbnail
    private string GetThumb(CourseDto c)
    {
        if (!string.IsNullOrEmpty(c.ThumbnailImagePath))
        {
            return $"{BackendUrl.TrimEnd('/')}/{c.ThumbnailImagePath.TrimStart('/')}";
        }
        return "https://via.placeholder.com/400x225?text=No+Image";
    }

    protected override async Task OnInitializedAsync()
    {
        Network.StatusChanged += OnStatusChanged;
        await LoadAsync();
        var tData = await TrainersApi.GetAsync(null, 1, 100);
        allTrainers = tData?.Items ?? new();
    }
    private void OnStatusChanged() => InvokeAsync(StateHasChanged);
    public void Dispose() => Network.StatusChanged -= OnStatusChanged;

    async Task LoadAsync()
    {
        loading = true;
        try
        {
            data = await CoursesApi.GetAsync(q, pageNumber, pageSize);
            if (data?.Items != null) foreach (var c in data.Items) await LoadMaterialsAsync(c.Id);
        }
        finally { loading = false; StateHasChanged(); }
    }

    async Task UploadThumbAsync(int courseId, InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(10 * 1024 * 1024);
            await FilesApi.UploadCourseThumbnailAsync(courseId, stream, file.Name);
            await LoadAsync();
        }
        catch (Exception ex) { Console.WriteLine(ex.Message); }
    }

    async Task UploadMaterialAsync(InputFileChangeEventArgs e, int courseId)
    {
        var file = e.File;
        using var stream = file.OpenReadStream(20 * 1024 * 1024);
        var trainerId = data?.Items.FirstOrDefault(x => x.Id == courseId)?.TrainerId ?? 0;
        await FilesApi.UploadCourseMaterialAsync(courseId, trainerId, stream, file.Name, file.Name, null, "pdf");
        await LoadMaterialsAsync(courseId);
    }

    async Task LoadMaterialsAsync(int courseId)
    {
        materials[courseId] = await FilesApi.GetCourseMaterialsAsync(courseId) ?? new();
    }

    async Task HandleSubmit()
    {
        if (isEdit && editId != null)
        {
            editCourse.TrainerId = SelectedTrainerId;
            await CoursesApi.UpdateAsync(editId.Value, editCourse);
        }
        else
        {
            newCourse.TrainerId = SelectedTrainerId;
            await CoursesApi.CreateAsync(newCourse);
        }
        await LoadAsync(); CancelEdit();
    }

    void BeginEdit(CourseDto c)
    {
        isEdit = true; editId = c.Id; SelectedTrainerId = c.TrainerId;
        editCourse = new CourseUpdateDto
        {
            Title = c.Title,
            Description = c.Description,
            Category = c.Category,
            Level = c.Level,
            Status = c.Status,
            Visibility = c.Visibility,
            Language = c.Language,
            Duration = c.Duration,
            TotalLessons = c.TotalLessons,
            IsFree = c.IsFree,
            Price = c.Price,
            TrainerId = c.TrainerId
        };
    }
    void CancelEdit() { isEdit = false; editId = null; SelectedTrainerId = 0; }
    async Task DeleteAsync(int id) { await CoursesApi.DeleteAsync(id); await LoadAsync(); }
    async Task DeleteMaterialAsync(int cid, int mid) { await FilesApi.DeleteCourseMaterialAsync(cid, mid); await LoadMaterialsAsync(cid); }
    async Task Retry() => await LoadAsync();
    async Task Search() { pageNumber = 1; await LoadAsync(); }
}