@page "/trainers"
@using StudiBase.Shared.Clients
@using StudiBase.Shared.Contracts.DTOs
@using StudiBase.Shared.Contracts.Paging
@using StudiBase.Shared.Services
@using System.IO
@implements IDisposable
@inject TrainerApiClient Api
@inject FileApiClient FileClient
@inject ICameraService CameraService
@inject IGeolocationService GeoService
@inject INetworkService Network
@inject IGeocodingService Geocoding

<h2 class="fw-bold mb-3 text-center">Trainers</h2>

@* --- BANNER STATUS KONEKSI --- *@
@if (!Network.IsOnline)
{
    <div class="alert alert-danger d-flex align-items-center mb-4 shadow-sm">
        <i class="bi bi-wifi-off fs-4 me-3"></i>
        <div>
            <strong>Mode Offline Aktif!</strong><br />
            Fitur Create, Edit, dan Delete dinonaktifkan hingga koneksi tersedia kembali.
        </div>
    </div>
}

<div class="container-fluid px-0 mb-4">
    <div class="d-flex flex-wrap gap-2 justify-content-center">
        <input class="form-control" style="max-width:280px" placeholder="Search trainers..." @bind="q" />
        <button class="btn btn-primary" @onclick="Search"><i class="bi bi-search"></i> Search</button>
        <button class="btn btn-outline-secondary" @onclick="Retry"><i class="bi bi-arrow-clockwise"></i> Reload</button>
    </div>
</div>

@if (loading)
{
    <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
}
else
{
    @* --- FORM CREATE / EDIT (KOLOM LENGKAP) --- *@
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            @if (!isEdit)
            {
                <h5 class="card-title mb-3 fw-bold text-success"><i class="bi bi-plus-circle"></i> Create Trainer</h5>
                <EditForm Model="newTrainer" OnValidSubmit="CreateAsync" class="row g-3">
                    <DataAnnotationsValidator />
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="newTrainer.Name" placeholder="Full Name" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="newTrainer.Email" placeholder="Email" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="newTrainer.Phone" placeholder="Phone" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-12"><InputTextArea class="form-control" @bind-Value="newTrainer.Bio" placeholder="Biography" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="newTrainer.Skills" placeholder="Skills (CSV)" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="newTrainer.YearsOfExperience" placeholder="Years Exp" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="newTrainer.RatingAverage" placeholder="Rating" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="newTrainer.LinkedInUrl" placeholder="LinkedIn URL" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="newTrainer.Country" placeholder="Country" disabled="@(!Network.IsOnline)" /></div>

                    <div class="col-md-6">
                        <div class="input-group">
                            <InputText class="form-control" @bind-Value="newTrainer.PhotoUrl" placeholder="External Photo URL" disabled="@(!Network.IsOnline)" />
                            <button type="button" class="btn btn-outline-secondary" @onclick="TakePhotoForCreate" disabled="@(!Network.IsOnline)">📸 Camera</button>
                        </div>
                        @if (!string.IsNullOrEmpty(tempBase64Photo))
                        {
                            <img src="@tempBase64Photo" class="img-thumbnail mt-2" style="max-height: 100px;" />
                        }
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">Lat</span>
                            <InputNumber class="form-control" @bind-Value="newTrainer.Latitude" disabled="@(!Network.IsOnline)" />
                            <span class="input-group-text">Lng</span>
                            <InputNumber class="form-control" @bind-Value="newTrainer.Longitude" disabled="@(!Network.IsOnline)" />
                            <button type="button" class="btn btn-info text-white" @onclick="GetLocationAsync" disabled="@(!Network.IsOnline)">📍 GPS</button>
                        </div>
                    </div>
                    <div class="col-12"><button class="btn btn-success px-4" type="submit" disabled="@(!Network.IsOnline)">Create</button></div>
                </EditForm>
            }
            else
            {
                <h5 class="card-title mb-3 fw-bold text-primary"><i class="bi bi-pencil-square"></i> Edit Trainer (ID: @editId)</h5>
                <EditForm Model="editTrainer" OnValidSubmit="SaveEditAsync" class="row g-3">
                    <DataAnnotationsValidator />
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="editTrainer.Name" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="editTrainer.Email" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-4"><InputText class="form-control" @bind-Value="editTrainer.Phone" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-12"><InputTextArea class="form-control" @bind-Value="editTrainer.Bio" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="editTrainer.Skills" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="editTrainer.YearsOfExperience" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-3"><InputNumber class="form-control" @bind-Value="editTrainer.RatingAverage" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="editTrainer.LinkedInUrl" disabled="@(!Network.IsOnline)" /></div>
                    <div class="col-md-6"><InputText class="form-control" @bind-Value="editTrainer.Country" disabled="@(!Network.IsOnline)" /></div>

                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-secondary w-100 mb-2" @onclick="TakePhotoForEdit" disabled="@(!Network.IsOnline)">📸 New Photo</button>
                        <img src="@GetImageSrc(editId ?? 0, editTrainer.ProfilePicturePath, editTrainer.PhotoUrl)" class="img-thumbnail d-block mx-auto" style="max-height: 120px;" />
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">Lat</span>
                            <InputNumber class="form-control" @bind-Value="editTrainer.Latitude" disabled="@(!Network.IsOnline)" />
                            <span class="input-group-text">Lng</span>
                            <InputNumber class="form-control" @bind-Value="editTrainer.Longitude" disabled="@(!Network.IsOnline)" />
                            <button type="button" class="btn btn-info text-white" @onclick="GetLocationAsync" disabled="@(!Network.IsOnline)">📍 GPS</button>
                        </div>
                    </div>
                    <div class="col-12 d-flex gap-2">
                        <button class="btn btn-primary px-4" type="submit" disabled="@(!Network.IsOnline)">Save</button>
                        <button class="btn btn-secondary px-4" type="button" @onclick="CancelEdit">Cancel</button>
                    </div>
                </EditForm>
            }
        </div>
    </div>

    @* --- GRID TRAINER CARDS --- *@
    <div class="row g-4">
        @if (data?.Items != null)
        {
            @foreach (var t in data.Items)
            {
                <div class="col-sm-6 col-md-4 col-xl-3">
                    <div class="card h-100 border-0 shadow-sm text-center">
                        <div class="pt-4 text-center">
                            <img src="@GetImageSrc(t.Id, t.ProfilePicturePath, t.PhotoUrl)"
                                 class="rounded-circle border trainer-thumb" alt="@t.Name" />
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="fw-bold mb-1">@t.Name</h5>
                            <p class="text-muted small mb-1">@t.Email</p>

                            @* TAMPILAN ALAMAT (GEOCODING) *@
                            @if (t.Latitude.HasValue && t.Longitude.HasValue)
                            {
                                <div class="alert alert-light border-0 py-1 px-2 mb-2" style="font-size: 0.75rem; background: #f8f9fa;">
                                    <i class="bi bi-geo-alt-fill text-danger"></i>
                                    @(trainerAddresses.TryGetValue(t.Id, out var addr) ? addr : "Mencari alamat...")
                                </div>
                                <a href="@($"https://www.google.com/maps?q={t.Latitude},{t.Longitude}")"
                                   target="_blank" class="small text-decoration-none mb-3 d-block">
                                    <i class="bi bi-map"></i> View on Map
                                </a>
                            }

                            <p class="small text-muted mb-3 flex-grow-1">
                                @(t.Bio?.Length > 60 ? t.Bio.Substring(0, 60) + "..." : t.Bio)
                            </p>

                            <div class="mt-auto d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-fill" @onclick="() => BeginEdit(t)" disabled="@(!Network.IsOnline)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger flex-fill" @onclick="() => DeleteAsync(t.Id)" disabled="@(!Network.IsOnline)">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    string? q; int pageNumber = 1, pageSize = 12, totalPages;
    bool loading, isEdit; int? editId; string? tempBase64Photo;
    PagedResult<TrainerDto>? data;
    TrainerCreateDto newTrainer = new();
    TrainerUpdateDto editTrainer = new();
    private Dictionary<int, string> trainerAddresses = new();

    private string BackendUrl =>
#if WINDOWS
        "https://localhost:7231";
#else
        "https://loraine-seminiferous-snappily.ngrok-free.dev";
#endif

    protected override async Task OnInitializedAsync()
    {
        Network.StatusChanged += OnStatusChanged;
        await LoadAsync();
    }
    private void OnStatusChanged() => InvokeAsync(StateHasChanged);
    public void Dispose() => Network.StatusChanged -= OnStatusChanged;

    private string GetImageSrc(int id, string? profilePath, string? photoUrl)
    {
        if (editId == id && !string.IsNullOrEmpty(tempBase64Photo)) return tempBase64Photo;
        if (!string.IsNullOrEmpty(profilePath)) return $"{BackendUrl.TrimEnd('/')}/{profilePath.TrimStart('/')}";
        return photoUrl ?? "https://placehold.co/150x150?text=No+Img";
    }

    async Task LoadAsync()
    {
        loading = true;
        try
        {
            data = await Api.GetAsync(q, pageNumber, pageSize);
            totalPages = data is null || data.PageSize == 0 ? 0 : (int)Math.Ceiling((double)data.Total / data.PageSize);

            if (data?.Items != null)
            {
                foreach (var t in data.Items)
                {
                    if (t.Latitude.HasValue && t.Longitude.HasValue)
                    {
                        _ = Task.Run(async () =>
                        {
                            var addr = await Geocoding.GetAddressAsync(t.Latitude.Value, t.Longitude.Value);
                            trainerAddresses[t.Id] = addr ?? "Alamat tidak ditemukan";
                            await InvokeAsync(StateHasChanged);
                        });
                    }
                }
            }
        }
        finally { loading = false; StateHasChanged(); }
    }

    async Task GetLocationAsync()
    {
        var loc = await GeoService.GetCurrentLocationAsync();
        if (loc != null)
        {
            if (isEdit) { editTrainer.Latitude = loc.Latitude; editTrainer.Longitude = loc.Longitude; }
            else { newTrainer.Latitude = loc.Latitude; newTrainer.Longitude = loc.Longitude; }
        }
    }

    async Task TakePhotoForCreate()
    {
        var res = await CameraService.TakePhotoAsync();
        if (!string.IsNullOrEmpty(res)) { tempBase64Photo = res; StateHasChanged(); }
    }

    async Task TakePhotoForEdit()
    {
        if (editId == null) return;
        var res = await CameraService.TakePhotoAsync();
        if (!string.IsNullOrEmpty(res))
        {
            tempBase64Photo = res; StateHasChanged();
            using var s = GetStreamFromBase64(res);
            var path = await FileClient.UploadTrainerPhotoAsync(editId.Value, s, "profile_cam.jpg");
            if (path != null) editTrainer.ProfilePicturePath = path;
            await LoadAsync();
        }
    }

    private Stream GetStreamFromBase64(string d) => new MemoryStream(Convert.FromBase64String(d.Contains(",") ? d.Split(',')[1] : d));
    async Task CreateAsync()
    {
        var res = await Api.CreateAsync(newTrainer);
        if (res != null && tempBase64Photo != null)
        {
            using var s = GetStreamFromBase64(tempBase64Photo);
            await FileClient.UploadTrainerPhotoAsync(res.Id, s, "profile_cam.jpg");
        }
        newTrainer = new(); tempBase64Photo = null; await LoadAsync();
    }
    async Task SaveEditAsync()
    {
        if (editId != null) { await Api.UpdateAsync(editId.Value, editTrainer); tempBase64Photo = null; CancelEdit(); await LoadAsync(); }
    }
    void BeginEdit(TrainerDto t)
    {
        isEdit = true; editId = t.Id; tempBase64Photo = null;
        editTrainer = new TrainerUpdateDto
        {
            Name = t.Name,
            Email = t.Email,
            Bio = t.Bio,
            Phone = t.Phone,
            ProfilePicturePath = t.ProfilePicturePath,
            PhotoUrl = t.PhotoUrl,
            Latitude = t.Latitude,
            Longitude = t.Longitude,
            Skills = t.Skills,
            YearsOfExperience = t.YearsOfExperience,
            RatingAverage = t.RatingAverage,
            Country = t.Country
        };
    }
    void CancelEdit() { isEdit = false; editId = null; tempBase64Photo = null; }
    async Task DeleteAsync(int id) { await Api.DeleteAsync(id); await LoadAsync(); }
    async Task Search() { pageNumber = 1; await LoadAsync(); }
    async Task Retry() => await LoadAsync();
}

<style>
    .trainer-thumb {
        width: 100px;
        height: 100px;
        object-fit: cover;
    }
</style>